Bootstrap: docker-archive
From: ubuntu22.04.tar

%post
    # 更新系统并安装必要软件，包括wget
    apt-get update
    apt-get install -y wget vim less ca-certificates
    DEBIAN_FRONTEND=noninteractive TZ=Asia/Shanghai apt-get install -y tzdata

    # 在容器内下载并安装Miniconda到/opt目录
    wget https://mirrors.bfsu.edu.cn/github-release/conda-forge/miniforge/LatestRelease/Miniforge3-25.3.1-0-Linux-x86_64.sh
    bash Miniforge3-25.3.1-0-Linux-x86_64.sh -b -p /opt/miniconda3
    chmod --recursive a+rw /opt/miniconda3  # 设置权限

    # 初始化conda并设置自动激活base环境
    /opt/miniconda3/bin/conda init bash
    /opt/miniconda3/bin/conda config --set auto_activate_base true

    # 清理安装脚本
    rm Miniforge3-25.3.1-0-Linux-x86_64.sh

%environment
    export PATH="/opt/miniconda3/bin:$PATH"
    # 设置conda自动激活base环境
    export BASH_ENV="/opt/miniconda3/etc/profile.d/conda.sh"

%runscript
    # 当直接运行容器时也激活conda环境
    exec /bin/bash --init-file /opt/miniconda3/etc/profile.d/conda.sh "$@"

%startscript
    # 启动脚本同样激活conda环境
    exec /bin/bash --init-file /opt/miniconda3/etc/profile.d/conda.sh
